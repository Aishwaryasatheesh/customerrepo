package com.customerpolicy.service;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import com.customerpolicy.entity.Customer;
import com.customerpolicy.entity.PurchasedPolicy;
import com.customerpolicy.exception.CustomerNotFoundException;
import com.customerpolicy.exception.PolicyNotFoundException;
import com.customerpolicy.pojo.Policy;
import com.customerpolicy.pojo.PurchasePolicyRequest;
import com.customerpolicy.repository.CustomerRepository;
import com.customerpolicy.repository.PurchaseRepository;

import jakarta.transaction.Transactional;

@Service
@Transactional
public class PurchasePolicyService {

    @Autowired
    private PolicyServiceClient policyServiceClient;

    @Autowired
    private CustomerRepository customerRepository;

    @Autowired
    private PurchaseRepository purchasedPolicyRepository;

    public PurchasedPolicy purchasePolicy(Integer policyId, Integer customerId, PurchasePolicyRequest request) throws Exception {
        try {
            // Fetch the policy details from the Policy Microservice
            Policy policy = PurchasePolicyByPolicyId.getPolicyById(policyId);
            if (policy == null) {
                throw new PolicyNotFoundException("Policy with ID " + policyId + " not found, cannot proceed with purchase.");
            }

            // Fetch the customer details
            Customer customer = customerRepository.findById(customerId).orElse(null);
            if (customer == null) {
                throw new CustomerNotFoundException("Customer with ID " + customerId + " not found, cannot proceed with purchase.");
            }

            // Create a new PurchasedPolicy instance
            PurchasedPolicy purchasedPolicy = new PurchasedPolicy();
            purchasedPolicy.setPolicy(policy);
            purchasedPolicy.setCustomer(customer);
            purchasedPolicy.setPurchaseDate(LocalDateTime.now());
            purchasedPolicy.setPremium(request.getPremium());
            purchasedPolicy.setMaturityDate(request.getMaturityDate());
            purchasedPolicy.setStatus("Active");

            // Save the purchased policy to the database
            purchasedPolicyRepository.save(purchasedPolicy);

            return purchasedPolicy;
        } catch (Exception e) {
            // Handle any unexpected exceptions
            throw new Exception("Failed to purchase policy: " + e.getMessage(), e);
        }
    }
}




