package com.customerpolicy.service;

import java.time.LocalDate;
import java.util.Date;
import java.util.List;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.web.client.RestTemplate;

import com.customerpolicy.entity.Customer;
import com.customerpolicy.entity.Purchased;
import com.customerpolicy.entity.PurchasedPolicy;
import com.customerpolicy.exception.CustomerNotFoundException;
import com.customerpolicy.exception.PolicyNotFoundException;
import com.customerpolicy.pojo.Policy;
import com.customerpolicy.repository.CustomerRepository;
import com.customerpolicy.repository.PurchaseRepository;

import jakarta.transaction.Transactional;

@Service
public class PurchasePolicyService {
@Autowired
private PurchaseRepository purchasedRepository;
@Autowired
CustomerRepository customerRepository;
@Autowired
RestTemplate restTemplete;
@Transactional
public PurchasePolicyByPolicyId(PurchasePolicyRequest purchase) throws PolicyNotFoundException,CustomerNotFoundException{
	Customer customer = customerRepository.findByEmail(purchase.getEmail());
	if(customer==null)
		throw new CustomerNotFoundException("Please register to purchase a policy");
	 
	Policy policy = restTemplete.getForObject("http://localhost:8081/app2/policy/"+ purchase.getPolicById(),Policy.class);
	if(!policy.getActive())	
		throw new PolicyNotFoundException("Policy with ID"+ purchase.getPolicyId()+ "not found.");
		else {
			PurchasedPolicy purchasePolicy = new PurchasedPolicy();
			PurchasedPolicy.setPolicyId(purchase.getPolicyId());
			PurchasedPolicy.setCustomer(customer);
			PurchasedPolicy.setPremium(policy.getPremium());
			PurchasedPolicy.setPurchaseDate(LocalDate.now());
			PurchasedPolicy.setMaturityDate(purchasedPolicy.getPurchaseDate().plusYears(policy.getMaturityTime()));
			purchasedRepository.save(purchasedPolicy);
			restTemplete.getForObject("http://localhost:8081/app2/policy/update/"+purchasedRepository.getPolicyId(),Policy.class);
	}
}
